# FPS Overlay 技术限制与约束分析

## 文档目的

本文档全面记录在开发通用 FPS 显示工具过程中遇到的技术限制、约束条件和现实问题，为后续开发决策提供参考。

---

## 一、核心问题总结

### 1.1 两大核心挑战

| 挑战 | 描述 | 难度 |
|------|------|------|
| **全屏独占模式** | 普通窗口无法覆盖在全屏独占游戏上方 | 高 |
| **反作弊系统** | 任何形式的注入/Hook 都可能被检测 | 极高 |

### 1.2 问题本质

```
用户需求：所有游戏都能显示 FPS，无需任何配置

技术现实：
├── 窗口化/无边框游戏 → 可以实现 ✅
├── 全屏独占游戏 → 需要注入/驱动 ⚠️
└── 反作弊游戏 → 需要白名单/签名 ❌
```

---

## 二、显示模式限制

### 2.1 Windows 显示模式对比

| 模式 | DWM 状态 | 普通窗口覆盖 | 技术要求 |
|------|----------|--------------|----------|
| 窗口化 | 正常运行 | ✅ 可以 | 无特殊要求 |
| 无边框全屏 | 正常运行 | ✅ 可以 | 无特殊要求 |
| 全屏独占 | 被绕过 | ❌ 不可以 | 需要注入或驱动 |

### 2.2 全屏独占模式的技术原理

```
正常窗口模式：
┌─────────────────────────────────────┐
│  DWM (Desktop Window Manager)       │ ← 合成所有窗口
│  ┌─────────┐  ┌─────────┐          │
│  │ 游戏窗口 │  │ 覆盖窗口 │          │ ← 可以叠加
│  └─────────┘  └─────────┘          │
└─────────────────────────────────────┘

全屏独占模式：
┌─────────────────────────────────────┐
│        游戏直接控制 GPU              │ ← DWM 被绕过
│                                     │
│        覆盖窗口无法显示 ❌            │ ← 普通窗口被忽略
│                                     │
└─────────────────────────────────────┘
```

### 2.3 解决全屏独占的方法

| 方法 | 可行性 | 说明 |
|------|--------|------|
| 禁用全屏优化 | ✅ 可行 | 需要用户手动设置或修改注册表 |
| DLL 注入 + Hook | ✅ 可行 | 在游戏进程内渲染 |
| 内核驱动 | ✅ 可行 | 在 GPU 驱动层面渲染 |
| 硬件覆盖 | ⚠️ 复杂 | 需要显卡厂商 SDK |

---

## 三、反作弊系统限制

### 3.1 主流反作弊系统

| 系统 | 使用游戏 | 检测级别 |
|------|----------|----------|
| Vanguard | Valorant, LOL | 内核级 |
| EasyAntiCheat (EAC) | Fortnite, Apex | 内核级 |
| BattlEye | PUBG, R6 | 内核级 |
| VAC | CS2, Dota2 | 用户级 |
| 游戏自带 | 各种网游 | 不等 |

### 3.2 反作弊检测手段

| 检测手段 | 描述 | 我们的风险 |
|----------|------|------------|
| **DLL 枚举** | 检查加载的所有 DLL | ❌ 高风险 |
| **签名验证** | 检查 DLL 是否有合法签名 | ❌ 高风险（无签名） |
| **Hook 检测** | 扫描已安装的 Hook | ❌ 高风险 |
| **全局钩子检测** | 枚举 SetWindowsHookEx | ❌ 高风险 |
| **白名单检查** | 检查是否是已知软件 | ❌ 高风险（新软件） |
| **行为分析** | 分析进程行为模式 | ⚠️ 中风险 |
| **内存扫描** | 检查可疑内存模式 | ⚠️ 中风险 |

### 3.3 我们 vs 已知软件对比

| 方面 | 我们的工具 | FRAPS/RTSS |
|------|------------|------------|
| 软件历史 | 新开发 | 10-20年历史 |
| 用户基数 | 0 | 数百万 |
| 代码签名 | ❌ 无 | ✅ 有 |
| 反作弊白名单 | ❌ 无 | ✅ 有 |
| 公司背景 | 个人/小团队 | 知名公司 |
| 信任度 | 未知 | 被广泛信任 |

### 3.4 白名单机制

```
反作弊系统白名单逻辑：

已知软件（FRAPS/RTSS/Discord/Steam）
    ↓
检查签名 + 哈希值
    ↓
匹配白名单 → 允许运行 ✅

未知软件（我们的工具）
    ↓
检测到注入/Hook 行为
    ↓
不在白名单 → 可能封禁 ❌
```

---

## 四、注入技术限制

### 4.1 注入方法对比

| 方法 | 原理 | 隐蔽性 | 反作弊检测 |
|------|------|--------|------------|
| CreateRemoteThread | 远程线程调用 LoadLibrary | 低 | ❌ 易检测 |
| SetWindowsHookEx | 全局钩子 | 中 | ❌ 易检测 |
| AppInit_DLLs | 注册表自动加载 | 中 | ❌ 易检测 |
| Manual Map | 手动映射，不调用 LoadLibrary | 高 | ⚠️ 可能检测 |
| APC Injection | 异步过程调用 | 高 | ⚠️ 可能检测 |
| 内核注入 | 驱动级注入 | 最高 | ⚠️ 可能检测 |

### 4.2 各方法详细限制

#### CreateRemoteThread + LoadLibrary
```
限制：
- 需要目标进程句柄（PROCESS_ALL_ACCESS）
- LoadLibrary 调用会被记录
- DLL 会出现在模块列表中
- 反作弊可以 Hook NtCreateThreadEx 检测
```

#### SetWindowsHookEx
```
限制：
- 仅对加载 user32.dll 的进程有效
- 全局钩子可被枚举 (EnumWindows)
- 反作弊可以检测 WH_CBT/WH_GETMESSAGE 等钩子
- 某些受保护进程可拒绝钩子
```

#### AppInit_DLLs
```
限制：
- Windows 8+ Secure Boot 默认禁用
- 仅对加载 user32.dll 的进程有效
- 需要管理员权限修改注册表
- 反作弊会检查此注册表项
```

#### Manual Map
```
限制：
- 需要自己实现 PE 加载器
- 需要处理导入表、重定位、TLS
- 某些反作弊会扫描可执行内存区域
- 实现复杂度高
```

---

## 五、驱动开发限制

### 5.1 驱动签名要求

| Windows 版本 | 要求 |
|--------------|------|
| Windows Vista-7 | 可使用测试签名 |
| Windows 8-10 | Secure Boot 要求正式签名 |
| Windows 11 | 强制要求 WHQL 或 EV 签名 |

### 5.2 签名成本

| 类型 | 成本 | 说明 |
|------|------|------|
| 测试签名 | 免费 | 需要用户启用测试模式 |
| EV 代码签名 | $400-600/年 | 可签名驱动 |
| WHQL 认证 | $2000+ | 微软官方认证 |

### 5.3 驱动开发风险

| 风险 | 影响 | 说明 |
|------|------|------|
| 系统崩溃 | 严重 | 蓝屏死机 |
| 兼容性问题 | 高 | 不同 Windows 版本差异 |
| 反作弊检测驱动 | 高 | 某些反作弊也运行在内核 |
| 安全漏洞 | 严重 | 内核代码漏洞影响整个系统 |

---

## 六、图形 API 限制

### 6.1 需要支持的 API

| API | 使用场景 | Hook 目标 |
|-----|----------|-----------|
| DirectX 9 | 老游戏 | IDirect3DDevice9::Present/EndScene |
| DirectX 10 | 少数游戏 | IDXGISwapChain::Present |
| DirectX 11 | 主流游戏 | IDXGISwapChain::Present |
| DirectX 12 | 新游戏 | IDXGISwapChain::Present |
| OpenGL | 部分游戏 | wglSwapBuffers |
| Vulkan | 新游戏 | vkQueuePresentKHR |

### 6.2 多 API 支持的复杂性

```
需要为每个 API 实现：
├── Hook 安装逻辑
├── 设备/上下文获取
├── 渲染代码
└── 资源管理

工作量估算：
- DX9:  1周
- DX11: 1周（已完成）
- DX12: 2周
- OpenGL: 1周
- Vulkan: 2周
```

---

## 七、现实约束

### 7.1 开发资源约束

| 约束 | 影响 |
|------|------|
| 无 EV 签名证书 | 无法签名驱动 |
| 无反作弊白名单 | 可能被检测/封禁 |
| 个人/小团队开发 | 资源有限 |
| 无法测试所有游戏 | 兼容性未知 |

### 7.2 法律/政策约束

| 约束 | 说明 |
|------|------|
| 游戏 TOS | 某些游戏禁止第三方软件 |
| 反作弊封禁 | 可能导致用户账号被封 |
| 责任问题 | 用户因使用被封需自担风险 |

---

## 八、方案可行性总结

### 8.1 按游戏类型分析

| 游戏类型 | 示例 | 可行方案 | 成功率 |
|----------|------|----------|--------|
| 无反作弊单机 | Hollow Knight, Cuphead | 注入方案 | 99% |
| 轻度反作弊 | 部分国产网游 | 注入方案 | 70% |
| 严格反作弊 | LOL, Valorant, PUBG | 几乎不可行 | <5% |

### 8.2 方案成功率对比

| 方案 | 无反作弊 | 轻度反作弊 | 严格反作弊 |
|------|----------|------------|------------|
| 外部窗口覆盖 | ✅ 窗口模式可用 | ✅ 窗口模式可用 | ✅ 窗口模式可用 |
| DLL 注入 | ✅ 100% | ⚠️ 70% | ❌ <5% |
| SetWindowsHookEx | ✅ 100% | ⚠️ 50% | ❌ <5% |
| 驱动方案 | ✅ 100% | ✅ 90% | ⚠️ 30% |
| 使用 FRAPS/RTSS | ✅ 100% | ✅ 100% | ✅ 100% |

---

## 九、结论与建议

### 9.1 核心结论

1. **技术上可行但商业上受限**
   - 技术实现不是最大障碍
   - 反作弊白名单是真正的壁垒

2. **白名单是关键**
   - FRAPS/RTSS 能工作是因为被白名单
   - 新软件几乎不可能获得白名单

3. **没有完美方案**
   - 任何方案都有trade-off
   - 需要根据目标用户群选择

### 9.2 建议的产品定位

```
明确定位：面向无反作弊游戏的 FPS 显示工具

目标用户：
├── 单机游戏玩家
├── 独立游戏玩家
├── 模拟器游戏玩家
└── 非竞技网游玩家

不适合：
├── LOL/Valorant 等严格反作弊游戏
└── 对这类游戏，建议使用游戏自带 FPS 或 FRAPS/RTSS
```

### 9.3 功能实现优先级

| 优先级 | 功能 | 目标 |
|--------|------|------|
| P0 | DLL 注入 + DX11 Hook | 覆盖大部分单机游戏 |
| P1 | SetWindowsHookEx 全局注入 | 自动化，无需配置 |
| P2 | 多 API 支持 (DX9/12/OpenGL) | 扩大兼容性 |
| P3 | 驱动方案 | 全屏独占支持 |

---

## 十、附录

### 10.1 相关文档

- `fraps-analysis.md` - FRAPS 技术分析
- `kernel-level-solution.md` - 驱动级方案设计
- `universal-solution.md` - 通用方案分析
- `fullscreen-solution-plan.md` - 全屏问题解决方案

### 10.2 参考资料

- [Microsoft: SetWindowsHookEx](https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowshookex)
- [Microsoft: Driver Signing](https://docs.microsoft.com/en-us/windows-hardware/drivers/install/driver-signing)
- [EasyAntiCheat Documentation](https://www.easy.ac/)
- [RivaTuner Statistics Server](https://www.guru3d.com/files-details/rtss-rivatuner-statistics-server-download.html)

---

*文档版本：1.0*  
*创建日期：2024年12月*  
*状态：技术分析完成*
