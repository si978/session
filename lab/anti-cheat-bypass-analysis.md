# 防注入游戏 FPS 显示方案分析

## 问题背景

带有反作弊系统的游戏（如 EAC、BattlEye、Vanguard）会阻止外部 DLL 注入，我们当前的注入方案无法使用。

---

## 方案对比

| 方案 | 原理 | 难度 | 风险 | 可行性 |
|------|------|------|------|--------|
| A. 外部透明窗口 | 独立进程覆盖层 | ⭐⭐ | 无 | ✅ 推荐 |
| B. ETW 事件追踪 | 系统级帧事件监控 | ⭐⭐⭐ | 无 | ✅ 推荐 |
| C. 驱动级 Hook | 内核驱动拦截 | ⭐⭐⭐⭐⭐ | 高 | ⚠️ 复杂 |
| D. 利用现有工具 | NVIDIA/AMD/Steam | ⭐ | 无 | ✅ 最简单 |
| E. DXGI Desktop Duplication | 截屏计算帧率 | ⭐⭐⭐ | 无 | ✅ 可行 |

---

## 方案 A：外部透明窗口覆盖

### 原理
创建一个独立的透明窗口，始终置顶显示在游戏上方。不注入任何东西到游戏进程。

### 架构
```
┌─────────────────────────────────────────┐
│           透明覆盖窗口 (我们的程序)      │  ← 独立进程
│              显示 FPS                   │
├─────────────────────────────────────────┤
│                                         │
│              游戏窗口                    │  ← 游戏进程（不接触）
│                                         │
└─────────────────────────────────────────┘
```

### 关键技术
- `WS_EX_LAYERED` + `WS_EX_TRANSPARENT` 创建透明窗口
- `SetWindowPos(HWND_TOPMOST)` 置顶
- 使用 ETW 或 PresentMon 获取帧率数据

### 优点
- 完全不接触游戏进程
- 不会触发反作弊
- 实现相对简单

### 缺点
- 全屏独占模式下可能不显示
- 需要另外获取帧率数据源

---

## 方案 B：ETW (Event Tracing for Windows)

### 原理
Windows 系统级事件追踪，可以监控 DXGI Present 调用，无需注入。

### 关键技术
- 使用 `Microsoft-Windows-DXGI` 提供程序
- 监控 `Present` 事件计算帧率
- Microsoft PresentMon 就是基于此实现

### 架构
```
┌──────────────┐     ETW 事件     ┌──────────────┐
│   游戏进程   │ ───────────────→ │  ETW 会话    │
│  (DXGI调用)  │                  │  (系统级)    │
└──────────────┘                  └──────┬───────┘
                                         │
                                         ↓
                                  ┌──────────────┐
                                  │  我们的程序   │
                                  │  计算并显示   │
                                  └──────────────┘
```

### 优点
- 系统级监控，完全合法
- 精确的帧时间数据
- 可以监控任何进程

### 缺点
- 需要管理员权限
- API 较复杂

---

## 方案 C：驱动级方案

### 原理
加载内核驱动，在显卡驱动层面拦截渲染调用。

### 说明
这是 MSI Afterburner / RivaTuner 的实现方式，需要：
- 签名驱动（EV 证书 $400+/年）
- 深入的内核开发知识
- 可能与反作弊冲突

**不推荐个人开发者采用**

---

## 方案 D：利用现有工具

### 已有白名单工具

| 工具 | 适用 | 快捷键 |
|------|------|--------|
| NVIDIA GeForce Experience | N卡 | Alt+R |
| AMD Adrenalin | A卡 | Ctrl+Shift+O |
| Windows Game Bar | 通用 | Win+G |
| Steam Overlay | Steam游戏 | Shift+Tab |
| Xbox Game Bar | 通用 | Win+G → 性能 |

这些工具已被大多数反作弊系统白名单。

---

## 方案 E：DXGI Desktop Duplication

### 原理
使用 Windows 8+ 的 Desktop Duplication API 捕获屏幕，分析帧变化计算帧率。

### 架构
```
┌──────────────┐
│   游戏进程   │
│   渲染画面   │
└──────┬───────┘
       ↓
┌──────────────┐     Desktop      ┌──────────────┐
│     DWM      │ ──Duplication──→ │  我们的程序   │
│  合成桌面    │      API         │  分析帧率    │
└──────────────┘                  └──────────────┘
```

### 优点
- 不接触游戏进程
- 可以分析任何窗口

### 缺点
- 全屏独占模式可能无法捕获
- 有一定性能开销
- 帧率计算是估算值

---

## 推荐方案：A + B 组合

**外部透明窗口 + ETW 帧率监控**

```
┌─────────────────────────────────────────────────────┐
│                    我们的程序                        │
│  ┌─────────────────┐    ┌─────────────────────────┐ │
│  │  ETW 监控模块   │───→│  透明覆盖窗口           │ │
│  │  获取帧率数据   │    │  显示 FPS              │ │
│  └─────────────────┘    └─────────────────────────┘ │
└─────────────────────────────────────────────────────┘
                    ↑ ETW 事件
┌─────────────────────────────────────────────────────┐
│                    游戏进程                          │
│                  (完全不接触)                        │
└─────────────────────────────────────────────────────┘
```

### 实现步骤

1. **ETW 监控器**
   - 订阅 `Microsoft-Windows-DXGI` 事件
   - 过滤目标进程的 Present 事件
   - 计算帧率

2. **透明覆盖窗口**
   - 创建透明置顶窗口
   - 跟随目标游戏窗口位置
   - 使用 GDI+ 或 Direct2D 渲染 FPS

3. **进程监控**
   - 监控目标游戏进程启动
   - 自动附加监控

---

## 下一步

需要我实现哪个方案？

1. **方案 A+B**：ETW + 透明窗口（推荐，完全安全）
2. **方案 E**：Desktop Duplication（简单但有限制）
3. **原型验证**：先做一个简单的透明窗口 Demo

请选择方向。
