name: AI Memory Validate

on:
  pull_request:
    paths:
      - ".ai/**"
      - ".github/workflows/ai_*.yml"
      - "CODEOWNERS"
      - ".gitignore"
  push:
    branches: ["main"]
    paths:
      - ".ai/**"
      - ".github/workflows/ai_*.yml"
      - "CODEOWNERS"
      - ".gitignore"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Unit tests (memctl)
        run: python -m unittest discover -s .ai/tests -p "test_*.py"

      - name: Validate memory
        run: python .ai/tools/memctl.py validate --commit "${{ github.sha }}"

      - name: Check stale
        run: python .ai/tools/memctl.py check-stale --commit "${{ github.sha }}"

      - name: Context pack determinism (seed task)
        shell: bash
        run: |
          set -euo pipefail
          TASK="TASK-2025-12-15-0001"
          python .ai/tools/memctl.py build-pack --commit "${{ github.sha }}" --task-id "$TASK" --out pack_1.json
          python .ai/tools/memctl.py build-pack --commit "${{ github.sha }}" --task-id "$TASK" --out pack_2.json
          python .ai/tools/memctl.py validate-pack --pack pack_1.json --task-id "$TASK"
          python .ai/tools/memctl.py validate-pack --pack pack_2.json --task-id "$TASK"
          python - <<'PY'
          import hashlib
          a = open("pack_1.json","rb").read()
          b = open("pack_2.json","rb").read()
          ha = hashlib.sha256(a).hexdigest()
          hb = hashlib.sha256(b).hexdigest()
          if ha != hb:
              raise SystemExit(f"non-deterministic build-pack output: {ha} vs {hb}")
          print(f"OK: deterministic context pack output sha256={ha}")
          PY
